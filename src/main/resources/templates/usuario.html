<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Gestión de Usuarios</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <div class="container mt-5">
        <h1 class="mb-4 text-center">Gestión de Usuarios</h1>

        <!-- Botón para abrir modal de crear usuario -->
        <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#createUsuarioModal">
            <i class="fas fa-plus"></i> Agregar Usuario
        </button>

        <!-- Tabla de usuarios -->
        <table class="table table-bordered table-hover align-middle">
            <thead class="table-dark text-center">
                <tr>
                    <th>Nombre Completo</th>
                    <th>Username</th>
                    <th>Rol</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="usuario : ${usuarios}">
                    <td th:text="${usuario.nombreCompleto}"></td>
                    <td th:text="${usuario.username}"></td>
                    <td th:text="${usuario.rol.nombreRol}"></td>
                    <td class="text-center">
                        <span th:if="${usuario.activo}" class="badge bg-success">Activo</span>
                        <span th:if="${!usuario.activo}" class="badge bg-secondary">Inactivo</span>
                    </td>
                    <td class="text-center">
                        <!-- Activar/Inactivar -->
                        <form th:action="@{/usuarios/toggleActivo}" method="post" style="display:inline;">
                            <input type="hidden" name="idUsuario" th:value="${usuario.idUsuario}" />
                            <input type="hidden" name="activo" th:value="${!usuario.activo}" />
                            <button type="submit"
                                th:classappend="${usuario.activo} ? 'btn btn-warning btn-sm' : 'btn btn-success btn-sm'">
                                <span th:text="${usuario.activo} ? 'Inactivar' : 'Activar'"></span>
                            </button>
                        </form>

                        <!-- Editar -->
                        <button class="btn btn-info btn-sm text-white ms-2" data-bs-toggle="modal"
                            th:attr="data-bs-target='#editUsuarioModal' + ${usuario.idUsuario}">
                            Editar
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Modal CREAR -->
    <div class="modal fade" id="createUsuarioModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form th:action="@{/usuarios/guardar}" method="post">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">Nuevo Usuario</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Nombre Completo</label>
                            <input type="text" name="nombreCompleto" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Username</label>
                            <input type="text" name="username" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Rol</label>
                            <select name="idRol" class="form-select" required>
                                <option value="">Seleccione...</option>
                                <option th:each="rol : ${roles}" th:value="${rol.idRol}" th:text="${rol.nombreRol}">
                                </option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Contraseña</label>
                            <input type="password" name="password" class="form-control" required>
                        </div>
                        <div class="col-12 form-check mt-2">
                            <!-- Siempre envía un valor -->
                            <input type="hidden" name="activo" value="false">
                            <input type="checkbox" class="form-check-input" name="activo" value="true">
                            <label class="form-check-label">Activo</label>
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modales EDITAR -->
    <div th:each="usuario : ${usuarios}" class="modal fade" th:id="'editUsuarioModal' + ${usuario.idUsuario}"
        tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form th:action="@{/usuarios/actualizar}" method="post">
                    <div class="modal-header bg-info text-white">
                        <h5 class="modal-title">Editar Usuario</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body row g-3">
                        <input type="hidden" name="idUsuario" th:value="${usuario.idUsuario}" />

                        <div class="col-md-6">
                            <label class="form-label">Nombre Completo</label>
                            <input type="text" name="nombreCompleto" th:value="${usuario.nombreCompleto}"
                                class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Username</label>
                            <input type="text" name="username" th:value="${usuario.username}" class="form-control"
                                required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Rol</label>
                            <select name="idRol" class="form-select" required>
                                <option value="">Seleccione...</option>
                                <option th:each="rol : ${roles}" th:value="${rol.idRol}" th:text="${rol.nombreRol}"
                                    th:selected="${usuario.rol.idRol == rol.idRol}">
                                </option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Contraseña</label>
                            <input type="password" name="password" class="form-control">
                            <small class="form-text text-muted">Dejar en blanco para no cambiarla</small>
                        </div>
                        <div class="col-12 form-check mt-2">
                            <input type="hidden" name="activo" value="false">
                            <input type="checkbox" class="form-check-input" name="activo" value="true" th:checked="${usuario.activo}">
                            <label class="form-check-label">Activo</label>
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-info text-white">Actualizar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bootstrap + FontAwesome -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/yourcode.js" crossorigin="anonymous"></script>
</body>

</html>