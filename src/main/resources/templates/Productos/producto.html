<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Gestión de Productos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <div class="container mt-5">
        <h1 class="mb-4 text-center">Gestión de Inventario - Productos</h1>

        <!-- Alertas por Flash Attributes -->
        <div th:if="${mensaje}" class="alert alert-success alert-dismissible fade show" role="alert">
            <strong>✔️</strong> <span th:text="${mensaje}">Operación exitosa.</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>⚠️</strong> <span th:text="${error}">Ocurrió un error.</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Alertas por Query Params (opcional) -->
        <div th:if="${param.ok}" class="alert alert-success alert-dismissible fade show" role="alert">
            <strong>✔️</strong>
            <span th:switch="${param.ok}">
                <span th:case="'creado'">Producto agregado correctamente.</span>
                <span th:case="'actualizado'">Producto actualizado correctamente.</span>
                <span th:case="'eliminado'">Producto eliminado correctamente.</span>
                <span th:case="*">Operación realizada correctamente.</span>
            </span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${param.err}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>⚠️</strong> <span th:text="${param.err}">Ocurrió un error.</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Botón crear -->
        <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#createProductoModal">
            Agregar Producto
        </button>

        <!-- Tabla -->
        <table class="table table-bordered table-hover align-middle">
            <thead class="table-dark text-center">
                <tr>
                    <th>ID</th>
                    <th>Código Barra</th>
                    <th>Nombre</th>
                    <th>Descripción</th>
                    <th>Categoría</th>
                    <th>Almacén</th>
                    <th>Proveedor</th>
                    <th>Precio Compra</th>
                    <th>Precio Venta</th>
                    <th>Stock</th>
                    <th>Stock Mínimo</th>
                    <th>Activo</th>
                    <th>Fecha Creación</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="producto : ${productos}">
                    <td th:text="${producto.idProducto}"></td>
                    <td th:text="${producto.codigoBarra}"></td>
                    <td th:text="${producto.nombre}"></td>
                    <td th:text="${producto.descripcion}"></td>
                    <td th:text="${producto.categoria != null ? producto.categoria.nombre : 'Sin categoría'}"></td>
                    <td th:text="${producto.almacen != null ? producto.almacen.nombre : 'Sin almacén'}"></td>
                    <td
                        th:text="${producto.proveedorPreferido != null ? producto.proveedorPreferido.nombreProveedor : 'Sin proveedor'}">
                    </td>
                    <td th:text="${producto.precioCompra}"></td>
                    <td th:text="${producto.precioVenta}"></td>
                    <td th:text="${producto.stock}"></td>
                    <td th:text="${producto.stockMinimo}"></td>
                    <td th:text="${producto.activo ? 'Sí' : 'No'}"></td>
                    <td th:text="${#temporals.format(producto.fechaCreacion, 'dd/MM/yyyy HH:mm')}"></td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-warning"
                            th:attr="data-bs-target='#editProductoModal' + ${producto.idProducto}"
                            data-bs-toggle="modal">
                            Editar
                        </button>
                        <a th:href="@{/productos/eliminar/{id}(id=${producto.idProducto})}"
                            class="btn btn-sm btn-danger"
                            onclick="return confirm('¿Seguro que deseas eliminar este producto?')">
                            Eliminar
                        </a>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Modal CREAR -->
    <div class="modal fade" id="createProductoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form th:action="@{/productos/guardar}" th:object="${newProducto}" method="post">
                    <div class="modal-header">
                        <h5 class="modal-title">Nuevo Producto</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>

                    <div class="modal-body row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Código Barra</label>
                            <input type="text" th:field="*{codigoBarra}" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Nombre</label>
                            <input type="text" th:field="*{nombre}" class="form-control" required>
                        </div>

                        <div class="col-12">
                            <label class="form-label">Descripción</label>
                            <textarea th:field="*{descripcion}" class="form-control"></textarea>
                        </div>

                        <!-- Categoría: SOLO ACTIVAS -->
                        <div class="col-md-6">
                            <label class="form-label">Categoría</label>
                            <select name="idCategoria" class="form-select" required>
                                <option value="">Seleccione...</option>
                                <option th:each="c : ${categorias}" th:if="${c.activo}" 
                                    th:value="${c.idCategoria}"
                                    th:text="${c.nombre}">
                                </option>
                            </select>
                            <div class="form-text text-muted">Solo se pueden asociar categorías activas.</div>
                        </div>

                        <!-- Almacén -->
                        <div class="col-md-6">
                            <label class="form-label">Almacén</label>
                            <select name="idAlmacen" class="form-select" required>
                                <option value="">Seleccione...</option>
                                <option th:each="a : ${almacenes}" th:value="${a.id}" th:text="${a.nombre}"></option>
                            </select>
                        </div>

                        <!-- Proveedor -->
                        <div class="col-md-6">
                            <label class="form-label">Proveedor</label>
                            <select name="idProveedor" class="form-select">
                                <option value="">Seleccione...</option>
                                <option th:each="p : ${proveedores}" th:value="${p.idProveedor}"
                                    th:text="${p.nombreProveedor}"></option>
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">Precio Compra</label>
                            <input type="number" step="0.01" th:field="*{precioCompra}" class="form-control" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Precio Venta</label>
                            <input type="number" step="0.01" th:field="*{precioVenta}" class="form-control" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Stock</label>
                            <input type="number" th:field="*{stock}" class="form-control" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Stock Mínimo</label>
                            <input type="number" th:field="*{stockMinimo}" class="form-control" required>
                        </div>

                        <div class="col-md-3 form-check mt-4">
                            <input type="checkbox" th:field="*{activo}" class="form-check-input" id="chkActivoCreate">
                            <label class="form-check-label" for="chkActivoCreate">Activo</label>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modales EDITAR -->
    <div th:each="producto : ${productos}" class="modal fade" th:id="'editProductoModal' + ${producto.idProducto}"
        tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form th:action="@{/productos/actualizar}" method="post">
                    <div class="modal-header">
                        <h5 class="modal-title">Editar Producto</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>

                    <div class="modal-body row g-3">
                        <input type="hidden" th:value="${producto.idProducto}" name="idProducto">

                        <div class="col-md-6">
                            <label class="form-label">Código Barra</label>
                            <input type="text" th:value="${producto.codigoBarra}" name="codigoBarra"
                                class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Nombre</label>
                            <input type="text" th:value="${producto.nombre}" name="nombre" class="form-control"
                                required>
                        </div>

                        <div class="col-12">
                            <label class="form-label">Descripción</label>
                            <textarea name="descripcion" class="form-control"
                                th:text="${producto.descripcion}"></textarea>
                        </div>

                        <!-- Categoría: mostrar todas, DESHABILITAR inactivas (salvo la seleccionada) -->
                        <div class="col-md-6">
                            <label class="form-label">Categoría</label>
                            <select name="idCategoria" class="form-select" required>
                                <option value="">Seleccione...</option>
                                <option th:each="c : ${categorias}" th:value="${c.idCategoria}"
                                    th:text="${c.activo ? c.nombre : c.nombre + ' (Inactiva)'}"
                                    th:selected="${producto.categoria != null && producto.categoria.idCategoria == c.idCategoria}"
                                    th:attr="disabled=${!c.activo and !(producto.categoria != null and producto.categoria.idCategoria == c.idCategoria)}">
                                </option>
                            </select>
                            <div class="form-text" th:if="${producto.categoria != null and !producto.categoria.activo}">
                                Esta categoría está inactiva; puedes cambiarla por una activa.
                            </div>
                        </div>

                        <!-- Almacén -->
                        <div class="col-md-6">
                            <label class="form-label">Almacén</label>
                            <select name="idAlmacen" class="form-select" required>
                                <option value="">Seleccione...</option>
                                <option th:each="a : ${almacenes}" th:value="${a.id}" th:text="${a.nombre}"
                                    th:selected="${producto.almacen != null && producto.almacen.id == a.id}">
                                </option>
                            </select>
                        </div>

                        <!-- Proveedor -->
                        <div class="col-md-6">
                            <label class="form-label">Proveedor</label>
                            <select name="idProveedor" class="form-select">
                                <option value="">Seleccione...</option>
                                <option th:each="p : ${proveedores}" th:value="${p.idProveedor}"
                                    th:text="${p.nombreProveedor}"
                                    th:selected="${producto.proveedorPreferido != null && producto.proveedorPreferido.idProveedor == p.idProveedor}">
                                </option>
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">Precio Compra</label>
                            <input type="number" step="0.01" th:value="${producto.precioCompra}" name="precioCompra"
                                class="form-control" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Precio Venta</label>
                            <input type="number" step="0.01" th:value="${producto.precioVenta}" name="precioVenta"
                                class="form-control" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Stock</label>
                            <input type="number" th:value="${producto.stock}" name="stock" class="form-control"
                                required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Stock Mínimo</label>
                            <input type="number" th:value="${producto.stockMinimo}" name="stockMinimo"
                                class="form-control" required>
                        </div>

                        <!-- Checkbox activo (patrón sin JS) -->
                        <div class="col-md-3 form-check mt-4">
                            <input type="checkbox" name="activo" value="true" th:checked="${producto.activo}"
                                class="form-check-input" th:id="'chkActivo__' + ${producto.idProducto}">
                            <label class="form-check-label"
                                th:for="'chkActivo__' + ${producto.idProducto}">Activo</label>
                            <input type="hidden" name="activo" value="false" />
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-success">Actualizar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>